name: Python CI

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ['3.9', '3.10']

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    - name: Run tests
      run: |
        python --version
        pytest
        black --check mixsea/

    - name: Check formatting
      run: black --check mixsea/

    - name: Push changes with black formatting
      run: |
        black mixsea/
        git diff --exit-code || { git commit -am "Apply Black formatting" && git push origin HEAD:main; }

    - name: Push changes
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@users.noreply.github.com'
        git push

    - name: Setup Miniconda
      run: |
        wget http://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
        bash miniconda.sh -b -f -p $HOME/miniconda
        export PATH="$HOME/miniconda/bin:$PATH"
        hash -r
        conda config --set always_yes yes
        conda config --add channels conda-forge
        conda update -q conda

    - name: Create Conda environment
      run: |
        conda env create -f environment.yml
        conda activate mixsea