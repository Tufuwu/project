name: Python CI

on:
  push:
    branches:
      - main  # 你可以根据需要修改为其他分支
  pull_request:
    branches:
      - main  # 同上

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [3.6, 3.7, 3.8, 3.9]

    steps:
      # Checkout the code
      - name: Checkout code
        uses: actions/checkout@v2

      # Set up Python
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}

      # Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade importlib-metadata
          pip install --upgrade pytest coverage
          pip install .  # test local installation
          pip install .[contrib]  # test optional install

      # Run tests
      - name: Run tests with coverage
        run: |
          pip freeze --all
          coverage run --source=. --omit=*__init__.py,setup.py -m pytest

      # Generate coverage report
      - name: Upload coverage report
        run: |
          coverage report
          coverage xml

      # Upload to CodeClimate
      - name: Upload to CodeClimate
        run: |
          curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
          chmod +x ./cc-test-reporter
          ./cc-test-reporter before-build
          ./cc-test-reporter after-build